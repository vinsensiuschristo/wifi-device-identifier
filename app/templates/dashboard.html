<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WiFi Device Identifier</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar h1 { font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .navbar a { color: white; text-decoration: none; opacity: 0.8; }
        .navbar a:hover { opacity: 1; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .stat-card .icon { font-size: 32px; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #333; }
        .stat-card .label { color: #888; font-size: 14px; margin-top: 5px; }
        
        .stat-card.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stat-card.primary .value, .stat-card.primary .label { color: white; }
        
        .section { margin-bottom: 30px; }
        .section h2 { color: #333; margin-bottom: 15px; font-size: 18px; }
        
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; color: #555; font-weight: 600; font-size: 13px; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        tr:hover { background: #fafafa; }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-brand { background: #e3f2fd; color: #1976d2; }
        .badge-price { background: #e8f5e9; color: #388e3c; }
        .badge-count { background: #fff3e0; color: #f57c00; }
        
        /* Styles baru untuk Price Scraping Feature */
        .badge-tokopedia { 
            background: linear-gradient(135deg, #00aa5b 0%, #00cc6a 100%); 
            color: white; 
        }
        
        /* Badge untuk sumber harga */
        .badge-source-tokopedia { background: #00aa5b; color: white; }
        .badge-source-database { background: #667eea; color: white; }
        .badge-source-none { background: #ccc; color: #666; }
        
        /* Link ke Tokopedia */
        .tokopedia-link {
            font-size: 11px;
            color: #00aa5b;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .tokopedia-link:hover {
            text-decoration: underline;
            color: #008f4c;
        }
        
        .two-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .two-columns { grid-template-columns: 1fr; } }
        
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #38a169; color: white; }
        .btn-danger { background: #e53e3e; color: white; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üìä WiFi Device Identifier - Dashboard</h1>
        <a href="/login">‚Üê Kembali ke Login</a>
    </nav>
    
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon">üë•</div>
                <div class="value">{{ stats.total_logins }}</div>
                <div class="label">Total Login</div>
            </div>
            <div class="stat-card">
                <div class="icon">üì±</div>
                <div class="value">{{ stats.unique_devices }}</div>
                <div class="label">Device Unik</div>
            </div>
            <div class="stat-card">
                <div class="icon">üë§</div>
                <div class="value">{{ stats.unique_users }}</div>
                <div class="label">User Unik</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="value">Rp {{ "{:,.0f}".format(stats.total_estimated_value).replace(',', '.') }}</div>
                <div class="label">Est. Total Nilai</div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="/api/export/csv" class="btn btn-success">üì• Export CSV</a>
            <a href="/api/export/json" class="btn btn-primary">üì• Export JSON</a>
            <button onclick="clearLogs()" class="btn btn-danger">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div class="two-columns">
            <!-- Device Summary -->
            <div class="section">
                <h2>üì± Top Devices</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Brand</th>
                                <th>Model</th>
                                <th>Login</th>
                                <th>Harga</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in device_summary %}
                            <tr>
                                <td><span class="badge badge-brand">{{ device.brand or '-' }}</span></td>
                                <td>{{ device.marketing_name or device.model_code }}</td>
                                <td><span class="badge badge-count">{{ device.login_count }}x</span></td>
                                <td>
                                    {% if device.price_idr %}
                                    <span class="badge badge-price">Rp {{ "{:,.0f}".format(device.price_idr).replace(',', '.') }}</span>
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" style="text-align: center; color: #888;">Belum ada data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Brand Summary -->
            <div class="section">
                <h2>üè¢ Summary per Brand</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Brand</th>
                                <th>Login</th>
                                <th>Models</th>
                                <th>Total Nilai</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for brand in brand_summary %}
                            <tr>
                                <td><strong>{{ brand.brand or 'Unknown' }}</strong></td>
                                <td>{{ brand.login_count }}</td>
                                <td>{{ brand.device_models }}</td>
                                <td>
                                    {% if brand.total_value %}
                                    Rp {{ "{:,.0f}".format(brand.total_value).replace(',', '.') }}
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" style="text-align: center; color: #888;">Belum ada data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Recent Logs -->
        <div class="section">
            <h2>üìã Login Terbaru</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Username</th>
                            <th>Device</th>
                            <th>OS</th>
                            <th>IP</th>
                            <th>Harga Database</th>
                            <th>Harga Tokopedia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_logs %}
                        <tr>
                            <td>{{ log.login_time }}</td>
                            <td>{{ log.username }}</td>
                            <td>
                                {% if log.brand %}<span class="badge badge-brand">{{ log.brand }}</span>{% endif %}
                                {{ log.marketing_name or log.model_code }}
                            </td>
                            <td>{{ log.os_type | capitalize }} {{ log.os_version or '' }}</td>
                            <td>{{ log.ip_address }}</td>
                            <td>
                                {% if log.price_idr %}
                                <span class="badge badge-price">Rp {{ "{:,.0f}".format(log.price_idr).replace(',', '.') }}</span>
                                {% else %}-{% endif %}
                            </td>
                            <td>
                                {% if log.scraped_price_min and log.scraped_price_max %}
                                <!-- Harga dari Tokopedia tersedia -->
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span class="badge badge-tokopedia">
                                        Rp {{ "{:,.0f}".format(log.scraped_price_min).replace(',', '.') }} - {{ "{:,.0f}".format(log.scraped_price_max).replace(',', '.') }}
                                    </span>
                                    {% if log.tokopedia_url %}
                                    <a href="{{ log.tokopedia_url }}" target="_blank" class="tokopedia-link">
                                        üîó Lihat di Tokopedia
                                    </a>
                                    {% endif %}
                                </div>
                                {% elif log.tokopedia_url %}
                                <!-- Ada URL tapi tidak ada harga (scraping gagal) -->
                                <a href="{{ log.tokopedia_url }}" target="_blank" class="tokopedia-link">
                                    üîç Cari di Tokopedia
                                </a>
                                {% else %}
                                <span style="color: #888;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td colspan="7" style="font-size: 11px; color: #666; word-break: break-all;">
                                <strong>User-Agent:</strong> {{ log.user_agent[:200] }}{% if log.user_agent|length > 200 %}...{% endif %}
                                {% if log.price_source %}
                                <span style="float: right;" class="badge badge-source-{{ log.price_source or 'none' }}">
                                    Sumber: {{ log.price_source or 'none' }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" style="text-align: center; color: #888;">Belum ada login</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Database Stats -->
        <div class="section">
            <h2>üìä Database Info</h2>
            <div class="stat-card" style="display: inline-block;">
                <p>Total Devices di DB: <strong>{{ db_stats.total_devices }}</strong></p>
                <p>Total Brands: <strong>{{ db_stats.total_brands }}</strong></p>
                <p>Devices dengan Harga: <strong>{{ db_stats.devices_with_price }}</strong></p>
            </div>
        </div>
    </div>
    
    <script>
        function clearLogs() {
            if (confirm('Hapus semua log? Tindakan ini tidak dapat dibatalkan.')) {
                fetch('/api/clear-logs', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        alert('Berhasil menghapus ' + data.deleted + ' log');
                        location.reload();
                    });
            }
        }
    </script>
</body>
</html>
